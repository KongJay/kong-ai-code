# postMessage æŠ€æœ¯è¯¦è§£

## ğŸ“š ä»€ä¹ˆæ˜¯ postMessageï¼Ÿ

`postMessage` æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ä¸ª **Web API**ï¼Œç”¨äº**ä¸åŒçª—å£/iframe ä¹‹é—´å®‰å…¨åœ°ä¼ é€’æ¶ˆæ¯**ã€‚

### ç®€å•ç†è§£

æƒ³è±¡ä¸¤ä¸ªæˆ¿é—´ï¼ˆçª—å£ï¼‰ä¹‹é—´ä¸èƒ½ç›´æ¥å¼€é—¨ï¼Œä½†å¯ä»¥é€šè¿‡**ä¼ çº¸æ¡ï¼ˆpostMessageï¼‰**æ¥é€šä¿¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         postMessage          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   çˆ¶é¡µé¢çª—å£     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚   iframe çª—å£    â”‚
â”‚  (localhost:3000)â”‚                              â”‚ (localhost:8123) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”’ ä¸ºä»€ä¹ˆéœ€è¦ postMessageï¼Ÿ

### æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼ˆSame-Origin Policyï¼‰

æµè§ˆå™¨æœ‰ä¸€ä¸ªå®‰å…¨è§„åˆ™ï¼š**ä¸åŒæºçš„é¡µé¢ä¸èƒ½ç›´æ¥è®¿é—®å¯¹æ–¹çš„ DOM æˆ–å˜é‡**ã€‚

**ä»€ä¹ˆæ˜¯"åŒæº"ï¼Ÿ**
- åè®®ï¼ˆhttp/httpsï¼‰ç›¸åŒ
- åŸŸåï¼ˆlocalhost/example.comï¼‰ç›¸åŒ  
- ç«¯å£ï¼ˆ3000/8123ï¼‰ç›¸åŒ

**ä½ çš„é¡¹ç›®åœºæ™¯ï¼š**
- çˆ¶é¡µé¢ï¼š`http://localhost:3000`ï¼ˆNext.js å‰ç«¯ï¼‰
- iframe é¢„è§ˆï¼š`http://localhost:8123/api/static/...`ï¼ˆåç«¯é™æ€æœåŠ¡ï¼‰

**ç»“æœï¼š** ä¸åŒæºï¼çˆ¶é¡µé¢**æ— æ³•ç›´æ¥**è®¿é—® iframe çš„ `contentDocument`ï¼Œæ‰€ä»¥éœ€è¦ `postMessage` æ¥é€šä¿¡ã€‚

## ğŸ’» åŸºæœ¬ç”¨æ³•

### 1. å‘é€æ¶ˆæ¯ï¼ˆçˆ¶é¡µé¢ â†’ iframeï¼‰

```javascript
// è·å– iframe å…ƒç´ 
const iframe = document.querySelector('iframe');

// å‘ iframe å‘é€æ¶ˆæ¯
iframe.contentWindow.postMessage({
  type: 'TOGGLE_EDIT_MODE',
  editMode: true
}, '*');  // '*' è¡¨ç¤ºå…è®¸ä»»ä½•ç›®æ ‡æºï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®æŒ‡å®šå…·ä½“åŸŸåï¼‰
```

**å‚æ•°è¯´æ˜ï¼š**
- ç¬¬ä¸€ä¸ªå‚æ•°ï¼šè¦å‘é€çš„æ•°æ®ï¼ˆé€šå¸¸æ˜¯å¯¹è±¡ï¼‰
- ç¬¬äºŒä¸ªå‚æ•°ï¼šç›®æ ‡æºï¼ˆ`'*'` è¡¨ç¤ºä»»ä½•æºï¼Œæˆ–æŒ‡å®šå¦‚ `'http://localhost:8123'`ï¼‰

### 2. æ¥æ”¶æ¶ˆæ¯ï¼ˆiframe å†…ï¼‰

```javascript
// åœ¨ iframe é¡µé¢ä¸­ç›‘å¬æ¶ˆæ¯
window.addEventListener('message', function(event) {
  // event.data æ˜¯æ¥æ”¶åˆ°çš„æ•°æ®
  // event.origin æ˜¯å‘é€æ–¹çš„æºï¼ˆç”¨äºå®‰å…¨æ£€æŸ¥ï¼‰
  
  if (event.data.type === 'TOGGLE_EDIT_MODE') {
    console.log('æ”¶åˆ°ç¼–è¾‘æ¨¡å¼åˆ‡æ¢:', event.data.editMode);
  }
});
```

### 3. åå‘é€šä¿¡ï¼ˆiframe â†’ çˆ¶é¡µé¢ï¼‰

```javascript
// iframe å†…å‘é€æ¶ˆæ¯ç»™çˆ¶é¡µé¢
window.parent.postMessage({
  type: 'ELEMENT_SELECTED',
  data: { elementInfo: {...} }
}, '*');
```

```javascript
// çˆ¶é¡µé¢æ¥æ”¶ iframe çš„æ¶ˆæ¯
window.addEventListener('message', function(event) {
  if (event.data.type === 'ELEMENT_SELECTED') {
    console.log('é€‰ä¸­äº†å…ƒç´ :', event.data.data.elementInfo);
  }
});
```

## ğŸ¯ ä½ é¡¹ç›®ä¸­çš„å®é™…åº”ç”¨

### åœºæ™¯ 1ï¼šçˆ¶é¡µé¢å‘é€ç¼–è¾‘è„šæœ¬åˆ° iframeï¼ˆè·¨åŸŸå›é€€æ–¹æ¡ˆï¼‰

**ä½ç½®ï¼š** `visualEditor.ts` ç¬¬ 201-204 è¡Œ

```typescript
// å½“æ— æ³•ç›´æ¥è®¿é—® iframe DOM æ—¶ï¼ˆè·¨åŸŸï¼‰ï¼Œé€šè¿‡ postMessage å‘é€è„šæœ¬
this.sendMessageToIframe({
  type: 'INJECT_SCRIPT',
  script: this.generateEditScript(),  // ç”Ÿæˆçš„ç¼–è¾‘è„šæœ¬ä»£ç 
})
```

**æ‰§è¡Œæµç¨‹ï¼š**
1. çˆ¶é¡µé¢æ£€æµ‹åˆ°è·¨åŸŸï¼ˆ`contentDocument` ä¸º `null`ï¼‰
2. é€šè¿‡ `postMessage` å‘é€è„šæœ¬ä»£ç å­—ç¬¦ä¸²
3. iframe å†…çš„æ¥æ”¶å™¨è„šæœ¬ï¼ˆåç«¯æ³¨å…¥çš„ï¼‰æ¥æ”¶å¹¶æ‰§è¡Œ

### åœºæ™¯ 2ï¼šiframe é€‰ä¸­å…ƒç´ åé€šçŸ¥çˆ¶é¡µé¢

**ä½ç½®ï¼š** `visualEditor.ts` ç¬¬ 440-443 è¡Œï¼ˆç”Ÿæˆçš„è„šæœ¬å†…ï¼‰

```javascript
// iframe å†…ï¼Œç”¨æˆ·ç‚¹å‡»å…ƒç´ å
window.parent.postMessage({
  type: 'ELEMENT_SELECTED',
  data: { elementInfo }
}, '*');
```

**çˆ¶é¡µé¢æ¥æ”¶ï¼š** `page.tsx` ç¬¬ 161-163 è¡Œ

```typescript
window.addEventListener('message', (event) => {
  visualEditorRef.current?.handleIframeMessage(event);
});
```

### åœºæ™¯ 3ï¼šåˆ‡æ¢ç¼–è¾‘æ¨¡å¼

**çˆ¶é¡µé¢å‘é€ï¼š** `visualEditor.ts` ç¬¬ 229-232 è¡Œ

```typescript
this.sendMessageToIframe({
  type: 'TOGGLE_EDIT_MODE',
  editMode: true,
})
```

**iframe æ¥æ”¶å¹¶å¤„ç†ï¼š** ç”Ÿæˆçš„è„šæœ¬å†…ï¼ˆç¬¬ 402-415 è¡Œï¼‰

```javascript
window.addEventListener('message', (event) => {
  const { type, editMode } = event.data;
  switch (type) {
    case 'TOGGLE_EDIT_MODE':
      isEditMode = editMode;
      // å¼€å¯/å…³é—­ç¼–è¾‘åŠŸèƒ½
      break;
  }
});
```

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

### âš ï¸ ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **ä¸è¦ä½¿ç”¨ `'*'` ä½œä¸ºç›®æ ‡æº**

```javascript
// âŒ ä¸å®‰å…¨ï¼ˆå…è®¸ä»»ä½•æºæ¥æ”¶ï¼‰
iframe.contentWindow.postMessage(data, '*');

// âœ… å®‰å…¨ï¼ˆåªå…è®¸æŒ‡å®šæºï¼‰
iframe.contentWindow.postMessage(data, 'https://trusted-domain.com');
```

2. **éªŒè¯æ¶ˆæ¯æ¥æº**

```javascript
window.addEventListener('message', function(event) {
  // éªŒè¯æ¥æº
  if (event.origin !== 'https://trusted-domain.com') {
    return; // å¿½ç•¥ä¸ä¿¡ä»»çš„æ¶ˆæ¯
  }
  
  // å¤„ç†æ¶ˆæ¯
  console.log(event.data);
});
```

3. **éªŒè¯æ¶ˆæ¯ç±»å‹å’Œå†…å®¹**

```javascript
window.addEventListener('message', function(event) {
  // éªŒè¯æ¶ˆæ¯ç»“æ„
  if (!event.data || typeof event.data !== 'object') {
    return;
  }
  
  if (event.data.type === 'INJECT_SCRIPT') {
    // è¿›ä¸€æ­¥éªŒè¯ script å†…å®¹æ˜¯å¦å®‰å…¨
    const script = event.data.script;
    // æ‰§è¡Œå‰å¯ä»¥åšå®‰å…¨æ£€æŸ¥
  }
});
```

## ğŸ“Š å®Œæ•´é€šä¿¡æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      çˆ¶é¡µé¢ (localhost:3000)                 â”‚
â”‚                                                               â”‚
â”‚  1. ç”¨æˆ·ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®                                         â”‚
â”‚  2. VisualEditor.enableEditMode()                            â”‚
â”‚  3. å°è¯•ç›´æ¥æ³¨å…¥è„šæœ¬ï¼ˆåŒæºï¼‰æˆ– postMessageï¼ˆè·¨åŸŸï¼‰             â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  sendMessageToIframe({                               â”‚    â”‚
â”‚  â”‚    type: 'INJECT_SCRIPT',                            â”‚    â”‚
â”‚  â”‚    script: '...'                                     â”‚    â”‚
â”‚  â”‚  })                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†“ postMessage                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    iframe é¢„è§ˆé¡µ (localhost:8123)           â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ¥æ”¶å™¨è„šæœ¬ï¼ˆåç«¯æ³¨å…¥ï¼‰                                â”‚    â”‚
â”‚  â”‚  window.addEventListener('message', (event) => {       â”‚    â”‚
â”‚  â”‚    if (event.data.type === 'INJECT_SCRIPT') {         â”‚    â”‚
â”‚  â”‚      new Function(event.data.script)();               â”‚    â”‚
â”‚  â”‚    }                                                  â”‚    â”‚
â”‚  â”‚  });                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç¼–è¾‘è„šæœ¬æ‰§è¡Œï¼š                                        â”‚    â”‚
â”‚  â”‚  - æ·»åŠ  hover/click ç›‘å¬å™¨                            â”‚    â”‚
â”‚  â”‚  - ç”¨æˆ·ç‚¹å‡»å…ƒç´                                        â”‚    â”‚
â”‚  â”‚  - window.parent.postMessage({                        â”‚    â”‚
â”‚  â”‚      type: 'ELEMENT_SELECTED',                        â”‚    â”‚
â”‚  â”‚      data: { elementInfo }                           â”‚    â”‚
â”‚  â”‚    })                                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†‘ postMessage                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      çˆ¶é¡µé¢æ¥æ”¶æ¶ˆæ¯                           â”‚
â”‚                                                               â”‚
â”‚  window.addEventListener('message', (event) => {                â”‚
â”‚    visualEditorRef.current?.handleIframeMessage(event);      â”‚
â”‚  });                                                          â”‚
â”‚                                                               â”‚
â”‚  â†’ æ›´æ–° UIï¼Œæ˜¾ç¤ºé€‰ä¸­å…ƒç´ ä¿¡æ¯                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ€»ç»“

1. **postMessage æ˜¯ä»€ä¹ˆï¼Ÿ**  
   æµè§ˆå™¨æä¾›çš„è·¨çª—å£/è·¨åŸŸé€šä¿¡ API

2. **ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**  
   æµè§ˆå™¨çš„åŒæºç­–ç•¥é˜»æ­¢ç›´æ¥è®¿é—®è·¨åŸŸé¡µé¢çš„ DOM

3. **æ€ä¹ˆç”¨ï¼Ÿ**  
   - å‘é€ï¼š`targetWindow.postMessage(data, origin)`
   - æ¥æ”¶ï¼š`window.addEventListener('message', handler)`

4. **ä½ é¡¹ç›®ä¸­çš„ç”¨é€”ï¼Ÿ**  
   - è·¨åŸŸ iframe æ³¨å…¥ç¼–è¾‘è„šæœ¬
   - iframe é€‰ä¸­å…ƒç´ åé€šçŸ¥çˆ¶é¡µé¢
   - çˆ¶é¡µé¢æ§åˆ¶ iframe çš„ç¼–è¾‘æ¨¡å¼å¼€å…³

5. **å®‰å…¨è¦ç‚¹ï¼Ÿ**  
   - ç”Ÿäº§ç¯å¢ƒæŒ‡å®šå…·ä½“ç›®æ ‡æºï¼ˆä¸ç”¨ `'*'`ï¼‰
   - éªŒè¯æ¶ˆæ¯æ¥æºï¼ˆ`event.origin`ï¼‰
   - éªŒè¯æ¶ˆæ¯å†…å®¹ç»“æ„

## ğŸ“– å»¶ä¼¸å­¦ä¹ 

- [MDN: Window.postMessage()](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage)
- [MDN: åŒæºç­–ç•¥](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)
- [Web API: postMessage æœ€ä½³å®è·µ](https://web.dev/cross-document-messaging/)

